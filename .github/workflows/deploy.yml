name: Auto Deploy Node.js API
on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to AlwaysData
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        timeout: 60s
        command_timeout: 5m
        script: |
          cd ~/www/morenaas
          echo "üîÑ Updating code..."
          git pull origin master
          
          echo "üì¶ Installing dependencies..."
          npm install --only=production
          
          echo "üîç Finding Node.js process ID (PID)..."
          PID=$(pgrep -f "node server/app.js")
          
          if [ -z "$PID" ]; then
            echo "‚ö†Ô∏è Could not find running Node.js process. It might be starting or stopped."
            mkdir -p tmp
            touch tmp/restart.txt
          else
            echo "üîÑ Sending SIGUSR2 signal to process $PID..."
            kill -SIGUSR2 $PID
            echo "‚úÖ Restart signal sent directly to the application."
          fi
          
          echo "‚úÖ Deployment completed!"
