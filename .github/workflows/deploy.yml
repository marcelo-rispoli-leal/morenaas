name: Auto Deploy Node.js API
on:
  push:
    branches: [ master ]
  workflow_dispatch:  # Deploy manual quando necess√°rio

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to AlwaysData
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          cd ~/www/morenaas
          echo "üîÑ Atualizando c√≥digo..."
          git pull origin master
          
          echo "üì¶ Instalando depend√™ncias..."
          npm install --only=production
          
          echo "üîÑ Parando processos Node.js existentes..."
          # Para todos os processos Node.js do usu√°rio
          pkill -f "node.*app.js" 2>/dev/null || true
          pkill -f "node.*server.js" 2>/dev/null || true
          pkill -f "node.*index.js" 2>/dev/null || true
          sleep 2
          
          echo "üöÄ Iniciando nova inst√¢ncia da API..."
          # Inicia a aplica√ß√£o em background
          nohup node app.js > ~/logs/api.log 2>&1 &
          
          echo "‚è≥ Aguardando inicializa√ß√£o..."
          sleep 5
          
          echo "üîç Verificando se a API est√° rodando..."
          # Verifica se o processo est√° ativo
          if pgrep -f "node.*app.js" > /dev/null; then
            echo "‚úÖ API iniciada com sucesso!"
            echo "üìä Processos Node.js ativos:"
            pgrep -f "node" -l || true
          else
            echo "‚ùå Falha ao iniciar a API"
            echo "üìã √öltimas linhas do log:"
            tail -10 ~/logs/api.log 2>/dev/null || echo "Log n√£o encontrado"
            exit 1
          fi
          
          echo "‚úÖ Deploy conclu√≠do!"
